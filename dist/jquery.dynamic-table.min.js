/*! dynamic-table - v0.0.1 - 2014-11-22
* Copyright (c) 2014 Ross Basarevych; Licensed MIT */
!function(a){var b="dynamicTable",c="plugin_"+b,d=function(a,b){this.id=a.attr("id"),this.element=a,this.options={rowIdColumn:null,mapper:null,pageSizes:[15,30,50,100,0],tableClass:"table table-striped table-hover table-condensed",loaderImage:"img/loader.gif",strings:{BANNER_LOADING:"Loading... Please wait",BANNER_EMPTY:"Nothing found",BUTTON_PAGE_SIZE:"Page size",BUTTON_COLUMNS:"Columns",BUTTON_REFRESH:"Refresh",BUTTON_OK:"OK",BUTTON_CLEAR:"Clear",BUTTON_CANCEL:"Cancel",TITLE_FILTER_WINDOW:"Filter",LABEL_PAGE_OF_1:"Page",LABEL_PAGE_OF_2:"of {0}",LABEL_FILTER_LIKE:"Strings like",LABEL_FILTER_EQUAL:"Values equal to",LABEL_FILTER_BETWEEN_START:"Values greater than or equal to",LABEL_FILTER_BETWEEN_END:"Values less than or equal to",LABEL_FILTER_NULL:"Include rows with empty value in this column",LABEL_TRUE:"True",LABEL_FALSE:"False",DATE_TIME_FORMAT:"YYYY-MM-DD HH:mm:ss"}},this.columns=[],this.rows=[],this.filters={},this.sortColumn=null,this.sortDir="asc",this.pageNumber=1,this.pageSize=15,this.totalPages=1,this.visibleColumns=0,this.init(b)};d.prototype={init:function(b){a.extend(this.options,b),e(this);var c=this;a.getJSON(this.options.url,{query:"describe"},function(a){a.success===!0&&(c.columns=a.columns,f(c),c.refresh())})},refresh:function(b){var c=this;c.enable(!1);var d={query:"data",filters:JSON.stringify(c.filters),sort_column:JSON.stringify(c.sortColumn),sort_dir:JSON.stringify(c.sortDir),page_number:JSON.stringify(c.pageNumber),page_size:JSON.stringify(c.pageSize)};"undefined"!=typeof b&&a.each(b,function(a,b){d[a]=JSON.stringify(b)});var e=this.element.find("tbody td.selector input:checked");a.getJSON(this.options.url,d,function(b){return b.success!==!0?void c.enable(!0):(c.sortColumn=b.sort_column,c.sortDir=b.sort_dir,c.pageNumber=b.page_number,c.pageSize=b.page_size,c.totalPages=b.total_pages,c.filters=b.filters,c.rows=b.rows,m(c),a.each(e,function(b,d){c.toggleSelected(a(d).val())}),void c.enable(!0))})},enable:function(b){var c=this;a.each(this.columns,function(a){j(c,a,b)}),k(c,!b),l(c,b)},setSize:function(a){this.refresh({page_size:a})},setPage:function(a){a=parseInt(a),1>a?a=1:a>this.totalPages&&(a=this.totalPages),this.refresh({page_number:a})},setFilters:function(a,b){var c=this.filters;c[a]=b,this.refresh({filters:c})},toggleSort:function(a){var b="asc";this.sortColumn==a&&(b="asc"==this.sortDir?"desc":"asc"),this.refresh({sort_column:a,sort_dir:b})},toggleColumn:function(a){var b=this.columns[a],c=this.columns[a].visible=!b.visible;c?this.visibleColumns++:this.visibleColumns--,this.element.find("thead th[data-column-id="+a+"]").css("display",c?"table-cell":"none"),this.element.find("tbody td[data-column-id="+a+"]").css("display",c?"table-cell":"none"),this.element.find("thead.empty td").prop("colspan",this.visibleColumns),this.element.find("tfoot td").prop("colspan",this.visibleColumns),this.element.find("tfoot a[data-column-id="+a+"] i").attr("class","fa "+(c?"fa-check-square-o":"fa-square-o"))},toggleSelected:function(b){var c=a("tbody tr[data-row-id="+b+"] td.selector input"),d=!c.prop("checked");c.prop("checked",d),d?c.closest("tr").addClass("success"):c.closest("tr").removeClass("success");var e=this.element.find("tbody.data td.selector input:checked");this.element.find("thead th.selector input").prop("checked",e.length==this.rows.length)},getSelected:function(){var b=this.element.find("tbody.data td.selector input:checked"),c=[];return b.each(function(b,d){c.push(a(d).val())}),c}},a.fn[b]=function(a){var b=this.data(c);return b instanceof d?"undefined"!=typeof a&&b.init(a):(b=new d(this,a),this.data(c,b)),b};var e=function(b){b.element.html(""),b.element.addClass("dynamic-table");var c=a("<table></table>");c.attr("class",b.options.tableClass).appendTo(b.element),a("<div></div>").attr("class","overlay-back").appendTo(b.element),a("<div></div>").attr("class","overlay-loader").css("background-image","url("+b.options.loaderImage+")").appendTo(b.element);var d=a("<div></div>");d.attr("class","table-loader").css("text-align","center").text(b.options.strings.BANNER_LOADING).html(d.html()+'<br><img src="'+b.options.loaderImage+'"><br>').appendTo(b.element)},f=function(a){a.element.find(".table-loader").remove(),g(a),h(a),i(a)},g=function(b){var c=a("<thead></thead>"),d=a("<tr></tr>");d.appendTo(c),b.visibleColumns=0,null!=b.options.rowIdColumn&&(b.visibleColumns++,a('<th class="selector"><input type="checkbox"></th>').appendTo(d).find("input").prop("disabled",!0).on("change",function(){var c=b.element.find("tbody td.selector input");a(this).prop("checked")?c.prop("checked",!0).closest("tr").addClass("success"):c.prop("checked",!1).closest("tr").removeClass("success")})),a.each(b.columns,function(e,f){f.visible&&b.visibleColumns++;var g=a("<th></th>");if(g.attr("data-column-id",e).css("display",f.visible?"table-cell":"none").appendTo(d),a('<span class="text"></span>').text(f.title).appendTo(g),a('<a class="link"></a>').css("display","none").attr("href","javascript:void(0)").text(f.title).on("click",function(){b.toggleSort(e)}).appendTo(g),a('<i class="sort-asc fa fa-sort-alpha-asc"></i>').css("display","none").appendTo(g),a('<i class="sort-desc fa fa-sort-alpha-desc"></i>').css("display","none").appendTo(g),0!=f.filters.length){a('<button class="filter btn btn-default btn-xs"></button>').css("display","none").html('<i class="fa fa-filter"></i>').on("click",function(){var b=a(this).parent().find(".popover"),d=a(this).closest("th"),e=d.position(),f=c.position(),g=e.left,h=b.is(":visible");c.find(".popover").css("display","none"),e.left+b.width()>f.left+c.width()&&(g-=b.width()-d.width()),b.css("top",e.top+a(this).height()+15).css("left",g).css("display",h?"none":"block")}).appendTo(g);var h=a("<div></div>");h.attr("class","popover").appendTo(g),a("<h3></h3>").attr("class","popover-title").text(b.options.strings.TITLE_FILTER_WINDOW).appendTo(h);var i=a("<div></div>");i.attr("class","popover-content").appendTo(h);var j=a('<form onsubmit="return false"></form>');if(j.attr("role","form").appendTo(i),-1!=f.filters.indexOf("like")){var k=a("<div></div>");k.attr("class","form-group").appendTo(j),a("<label></label>").text(b.options.strings.LABEL_FILTER_LIKE+":").appendTo(k),a("<input></input>").attr("type","text").attr("class","form-control").attr("data-filter","like").appendTo(k)}if(-1!=f.filters.indexOf("equal"))if("boolean"==f.type){var k=a("<div></div>");k.attr("class","radio").appendTo(j);var l=a('<input type="radio">');l.attr("data-filter","equal-false").attr("name",b.id+"-"+e+"-equal").val(0);var m=a("<label></label>");m.html(l).html(m.html()+b.options.strings.LABEL_FALSE).appendTo(k);var k=a("<div></div>");k.attr("class","radio").appendTo(j);var l=a('<input type="radio">');l.attr("data-filter","equal-true").attr("name",b.id+"-"+e+"-equal").val(1);var m=a("<label></label>");m.html(l).html(m.html()+b.options.strings.LABEL_TRUE).appendTo(k)}else if("datetime"==f.type){var k=a("<div></div>");k.attr("class","form-group").appendTo(j),a("<label></label>").text(b.options.strings.LABEL_FILTER_EQUAL+":").appendTo(k);var n=a("<div></div>");n.attr("class","input-group date").appendTo(k);var o=a('<input type="text">');o.attr("class","form-control").attr("data-filter","equal").attr("data-date-format",b.options.strings.DATE_TIME_FORMAT).appendTo(n);var p=a("<span></span>");p.attr("class","input-group-btn").appendTo(n),a("<button></button>").attr("class","btn btn-default").html('<i class="fa fa-calendar"></i>').appendTo(p);var q=n.datetimepicker({useSeconds:!0})}else{var k=a("<div></div>");k.attr("class","form-group").appendTo(j),a("<label></label>").text(b.options.strings.LABEL_FILTER_EQUAL+":").appendTo(k),a("<input></input>").attr("type","text").attr("class","form-control").attr("data-filter","equal").appendTo(k)}if(-1!=f.filters.indexOf("between"))if("datetime"==f.type){var k=a("<div></div>");k.attr("class","form-group").appendTo(j),a("<label></label>").text(b.options.strings.LABEL_FILTER_BETWEEN_START+":").appendTo(k);var n=a("<div></div>");n.attr("class","input-group date").appendTo(k);var o=a('<input type="text">');o.attr("class","form-control").attr("data-filter","between-start").attr("data-date-format",b.options.strings.DATE_TIME_FORMAT).appendTo(n);var p=a("<span></span>");p.attr("class","input-group-btn").appendTo(n),a("<button></button>").attr("class","btn btn-default").html('<i class="fa fa-calendar"></i>').appendTo(p);var r=n.datetimepicker({useSeconds:!0}),k=a("<div></div>");k.attr("class","form-group").appendTo(j),a("<label></label>").text(b.options.strings.LABEL_FILTER_BETWEEN_END+":").appendTo(k);var n=a("<div></div>");n.attr("class","input-group date").appendTo(k);var o=a('<input type="text">');o.attr("class","form-control").attr("data-filter","between-end").attr("data-date-format",b.options.strings.DATE_TIME_FORMAT).appendTo(n);var p=a("<span></span>");p.attr("class","input-group-btn").appendTo(n),a("<button></button>").attr("class","btn btn-default").html('<i class="fa fa-calendar"></i>').appendTo(p);var s=n.datetimepicker({useSeconds:!0})}else{var k=a("<div></div>");k.attr("class","form-group").appendTo(j),a("<label></label>").text(b.options.strings.LABEL_FILTER_BETWEEN_START+":").appendTo(k),a("<input></input>").attr("type","text").attr("class","form-control").attr("data-filter","between-start").appendTo(k),a("<label></label>").text(b.options.strings.LABEL_FILTER_BETWEEN_END+":").appendTo(k),a("<input></input>").attr("type","text").attr("class","form-control").attr("data-filter","between-end").appendTo(k)}if(-1!=f.filters.indexOf("null")){var k=a("<div></div>");k.attr("class","checkbox").appendTo(j),a("<label></label>").html('<input type="checkbox" data-filter="null">'+b.options.strings.LABEL_FILTER_NULL).appendTo(k)}a("<button></button>").attr("type","submit").attr("class","btn btn-primary").text(b.options.strings.BUTTON_OK).on("click",function(){h.css("display","none");var a={};if(-1!=f.filters.indexOf("like")){var c=j.find("input[data-filter=like]");c.val().trim().length>0&&(a.like=c.val())}if(-1!=f.filters.indexOf("equal"))if("boolean"==f.type){var d=j.find("input[data-filter=equal-true]"),g=j.find("input[data-filter=equal-false]");d.prop("checked")?a.equal=!0:g.prop("checked")&&(a.equal=!1)}else if("datetime"==f.type){var i=j.find("input[data-filter=equal]"),k=q.data("DateTimePicker").getDate();i.val().trim().length>0&&null!=k&&(a.equal=k.unix())}else{var i=j.find("input[data-filter=equal]");i.val().trim().length>0&&(a.equal=i.val())}if(-1!=f.filters.indexOf("between"))if("datetime"==f.type){var l=j.find("input[data-filter=between-start]"),m=r.data("DateTimePicker").getDate(),n=j.find("input[data-filter=between-end]"),o=s.data("DateTimePicker").getDate(),p=null;l.val().trim().length>0&&null!=m&&(p=m.unix());var t=null;n.val().trim().length>0&&null!=o&&(t=o.unix()),(null!=p||null!=t)&&(a.between=[p,t])}else{var u=j.find("input[data-filter=between-start]"),v=j.find("input[data-filter=between-end]");u=u.val().trim().length>0?u.val():null,v=v.val().trim().length>0?v.val():null,(null!=u||null!=v)&&(a.between=[u,v])}if(-1!=f.filters.indexOf("null")){var w=j.find("input[data-filter=null]");w.prop("checked")&&(a.null=!0)}b.setFilters(e,a)}).appendTo(j),a("<span>&nbsp;</span>").appendTo(j),a("<button></button>").attr("class","btn btn-default").text(b.options.strings.BUTTON_CLEAR).on("click",function(){h.css("display","none"),b.setFilters(e,{})}).appendTo(j),a("<span>&nbsp;</span>").appendTo(j),a("<button></button>").attr("class","btn btn-default").text(b.options.strings.BUTTON_CANCEL).on("click",function(){h.css("display","none")}).appendTo(j)}}),c.appendTo(b.element.find("table"))},h=function(b){var c=a("<tbody></tbody>");c.attr("class","empty").attr("display","none");var d=a("<tr></tr>");d.appendTo(c);var e=a("<td></td>");e.attr("colspan",b.visibleColumns).appendTo(d);var f=a("<tbody></tbody>");f.attr("class","data").attr("display","none"),c.appendTo(b.element.find("table")),f.appendTo(b.element.find("table"))},i=function(b){var c=a("<tfoot></tfoot>"),d=a("<tr></tr>");d.appendTo(c);var e=a("<td></td>");e.attr("colspan",b.visibleColumns).appendTo(d);var f=a("<div></div>");f.attr("class","pull-right btn-toolbar").attr("role","toolbar").appendTo(e);var g=a("<div></div>");g.attr("class","btn-group dropdown dropup").attr("role","group").appendTo(f),a("<button></button>").attr("class","btn btn-default dropdown-toggle").attr("data-toggle","dropdown").html(b.options.strings.BUTTON_PAGE_SIZE+' <span class="caret"></span>').appendTo(g);var h=a("<ul></ul>");h.attr("class","dropdown-menu").attr("role","menu").appendTo(g),a.each(b.options.pageSizes,function(c,d){var e=a("<li></li>");e.attr("role","presentation").appendTo(h),d==b.pageSize&&e.attr("class","active"),a("<a></a>").attr("role","menuitem").attr("tabindex","-1").attr("href","javascript:void(0)").attr("data-size",d).text(0==d?"All":d).on("click",function(){var c=a(this);c.closest("ul").find("li").removeClass("active"),c.closest("li").addClass("active"),b.setSize(c.attr("data-size"))}).appendTo(e)});var g=a("<div></div>");g.attr("class","btn-group dropdown dropup").attr("role","group").appendTo(f),a("<button></button>").attr("class","btn btn-default dropdown-toggle").attr("data-toggle","dropdown").html(b.options.strings.BUTTON_COLUMNS+' <span class="caret"></span>').appendTo(g);var h=a("<ul></ul>");h.attr("class","dropdown-menu").attr("role","menu").appendTo(g),a.each(b.columns,function(c,d){var e=a("<li></li>");e.attr("role","presentation").appendTo(h);var f=a("<span></span>");f.text(d.title),a("<a></a>").attr("role","menuitem").attr("tabindex","-1").attr("href","javascript:void(0)").attr("data-column-id",c).html('<i class="fa '+(d.visible?"fa-check-square-o":"fa-square-o")+'"></i> '+f.html()).on("click",function(){b.toggleColumn(a(this).attr("data-column-id"))}).appendTo(e)});var i=a("<div></div>");i.attr("class","btn-toolbar").attr("role","toolbar").appendTo(e);var j=a("<div></div>");j.attr("class","btn-group").attr("role","group").appendTo(i),a("<button></button>").attr("class","btn btn-default").attr("data-action","first").html('<i class="fa fa-fast-backward"></i>').on("click",function(){b.setPage(1)}).appendTo(j),a("<button></button>").attr("class","btn btn-default").attr("data-action","previous").html('<i class="fa fa-step-backward"></i>').on("click",function(){b.setPage(b.pageNumber-1)}).appendTo(j);var j=a("<div></div>");j.attr("class","btn-group").attr("role","group").appendTo(i);var k=a("<div></div>");k.attr("class","input-group").appendTo(j),a("<span></span>").attr("class","input-group-addon pagination-before").appendTo(k),a("<input>").attr("class","form-control pagination-input").on("keypress",function(c){13==c.keyCode?b.setPage(a(this).val()):(c.keyCode<48||c.keyCode>57)&&c.preventDefault()}).on("keyup",function(){a(this).val()!=b.pageNumber?b.element.find("tfoot button[data-action=refresh]").addClass("btn-primary").removeClass("btn-default"):b.element.find("tfoot button[data-action=refresh]").addClass("btn-default").removeClass("btn-primary")}).appendTo(k),a("<span></span>").attr("class","input-group-addon pagination-after").appendTo(k);var j=a("<div></div>");j.attr("class","btn-group").attr("role","group").appendTo(i),a("<button></button>").attr("class","btn btn-default").attr("data-action","next").html('<i class="fa fa-step-forward"></i>').on("click",function(){b.setPage(b.pageNumber+1)}).appendTo(j),a("<button></button>").attr("class","btn btn-default").attr("data-action","last").html('<i class="fa fa-fast-forward"></i>').on("click",function(){b.setPage(b.totalPages)}).appendTo(j);var j=a("<div></div>");j.attr("class","btn-group").attr("role","group").appendTo(i),a("<button></button>").attr("class","btn btn-default").attr("data-action","refresh").text(b.options.strings.BUTTON_REFRESH).on("click",function(){var a=b.element.find("tfoot input.pagination-input");b.refresh({page_number:a.val()})}).appendTo(j),c.appendTo(b.element.find("table"))},j=function(a,b,c){var d=a.columns[b];a.element.find(".selector input").prop("disabled",!c);var e=a.element.find("[data-column-id="+b+"]");e.find(".text").css("display",c&&d.sortable?"none":"inline"),e.find(".link").css("display",c&&d.sortable?"inline":"none"),e.find(".sort-asc").css("display",c&&a.sortColumn==b&&"asc"==a.sortDir?"inline":"none"),e.find(".sort-desc").css("display",c&&a.sortColumn==b&&"desc"==a.sortDir?"inline":"none"),e.find(".filter").css("display",c&&d.filters.length>0?"inline":"none")},k=function(b,c){var d=b.element.find("tbody.data"),e=d.position();a.each([".overlay-back",".overlay-loader"],function(a,f){var g=b.element.find(f);g.width(d.width()).height(d.height()).css("top",e.top).css("left",e.left).css("display",c?"block":"none")})},l=function(a,b){var c=!b||1==a.pageNumber;a.element.find("tfoot button[data-action=first]").prop("disabled",c),a.element.find("tfoot button[data-action=previous]").prop("disabled",c);var c=!b||a.pageNumber==a.totalPages;a.element.find("tfoot button[data-action=next]").prop("disabled",c),a.element.find("tfoot button[data-action=last]").prop("disabled",c),a.element.find("tfoot button[data-action=refresh]").prop("disabled",!b).addClass("btn-default").removeClass("btn-primary"),a.element.find("tfoot .pagination-input").prop("disabled",!b)},m=function(b){if(b.element.find(".pagination-input").val(b.pageNumber),b.element.find("tfoot .pagination-before").text(b.options.strings.LABEL_PAGE_OF_1.replace("{0}",b.totalPages)),b.element.find("tfoot .pagination-after").text(b.options.strings.LABEL_PAGE_OF_2.replace("{0}",b.totalPages)),b.element.find("thead button.filter").removeClass("btn-primary").addClass("btn-default"),a.each(b.columns,function(a,c){var d=b.element.find("thead th[data-column-id="+a+"]");if(d.find("input[data-filter=like]").val(""),d.find("input[data-filter=equal]").val(""),d.find("input[data-filter=equal-true]").prop("checked",!1),d.find("input[data-filter=equal-false]").prop("checked",!1),d.find("input[data-filter=between-start]").val(""),d.find("input[data-filter=between-end]").val(""),d.find("input[data-filter=null]").prop("checked",!1),"undefined"!=typeof b.filters[a]){var e=!1,f=b.filters[a].like;"undefined"!=typeof f&&(d.find("input[data-filter=like]").val(f),e=!0);var g=b.filters[a].equal;if("undefined"!=typeof g){if("boolean"==c.type)g?d.find("input[data-filter=equal-true]").prop("checked",!0):d.find("input[data-filter=equal-false]").prop("checked",!0);else if("datetime"==c.type){var h=d.find("input[data-filter=equal]").closest(".input-group");h.data("DateTimePicker").setDate(moment(1e3*g))}else d.find("input[data-filter=equal]").val(g);e=!0}var i=b.filters[a].between;if("undefined"!=typeof i){if("datetime"==c.type){if(null!=i[0]){var j=d.find("input[data-filter=between-start]").closest(".input-group");j.data("DateTimePicker").setDate(moment(1e3*i[0]))}if(null!=i[1]){var k=d.find("input[data-filter=between-end]").closest(".input-group");k.data("DateTimePicker").setDate(moment(1e3*i[1]))}}else null!=i[0]&&d.find("input[data-filter=between-start]").val(i[0]),null!=i[1]&&d.find("input[data-filter=between-end]").val(i[1]);e=!0}var l=b.filters[a].null;"undefined"!=typeof l&&(d.find("input[data-filter=null]").prop("checked",!0),e=!0),e&&d.find("button.filter").removeClass("btn-default").addClass("btn-primary")}}),0==b.rows.length){var c=b.element.find("tbody.data");c.css("display","none");var d=b.element.find("tbody.empty");return d.find("td").text(b.options.strings.BANNER_EMPTY),void d.css("display","table-row-group")}var c=a("<tbody></tbody>");c.attr("class","data"),a.each(b.rows,function(d,e){var f=a("<tr></tr>");if(null!=b.options.rowIdColumn){var g=e[b.options.rowIdColumn];f.attr("data-row-id",g);var h=a('<td class="selector"><input type="checkbox"></td>');h.appendTo(f).find("input").prop("disabled",!0).prop("value",g).on("click",function(){var c=a(this);c.prop("checked")?c.closest("tr").addClass("success"):c.closest("tr").removeClass("success");var d=b.element.find("tbody.data td.selector input:checked");b.element.find("thead th.selector input").prop("checked",d.length==b.rows.length)})}var i=null!=b.options.mapper?b.options.mapper(e):e;a.each(b.columns,function(c,d){var e=a("<td></td>");null==b.options.mapper?e.text(i[c]):e.html(i[c]),e.attr("data-column-id",c).css("display",d.visible?"table-cell":"none").appendTo(f)}),f.appendTo(c)}),b.element.find("tbody.empty").css("display","none"),b.element.find("tbody.data").replaceWith(c).css("display","table-row-group")}}(jQuery,window,document);